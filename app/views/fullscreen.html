{% extends "layouts/mainWithInter.html" %}
{% set serviceName= "HMLR title search" %}
{% set pageName="Fullscreen test" %}

{% set bodyClasses = "full-width" %}
{% set containerClasses = "full-width" %}


{% block beforeContent %}
<style>
  html,
  body {
    font-family: "Inter", sans-serif;
    font-optical-sizing: auto;
    font-style: normal;
  }

  .navbar {
    display: inline;
    min-width: 180px;
    max-width: 300px;
    overflow: hidden;
    padding-right: 10px;
  }

  .hmlr-map-wrapper {
    background-color: aliceblue;
  }

  .govuk-grid-column-20-percent {
    width: 20%;
    box-sizing: border-box;
    padding: 0 15px;
    float: left;
  }

  .govuk-main-wrapper {
    padding-top: 10px;
    padding-bottom: 10px;
  }

  .govuk-width-container {
    max-width: 98%;
    width: 98%;
  }

  .govuk-footer {
    display: none;
  }

  .govuk-service-navigation__service-name:not(:last-child) {
    margin-right: 0 ! important;
  }

  .links {
    min-width: 280px;
  }

  .logo {
    min-width: 260px;
  }

  .govuk-service-navigation__wrapper {
    margin-left: auto;
  }

  .govuk-summary-list__value {
    height: 50px;
  }

  .ol-scale-line {
    top: 780px;
    left: 20px;
  }

  .max-width {
    width: calc(100% - 300px);
    float: left;
  }

  .hmlr-map-wrapper {
    height: 760px;
  }

  .search-bar {
    display: flex;
    flex-direction: row;
    height: 38px;
  }

  .map__search_term {
    position: relative;
    z-index: 10;
    height: 38px;
    margin: 0;
    padding: 1px;
    border: 2px solid #0b0c0c;
    border-radius: 0;
    width: 85%;
  }

  .search-button {
    height: 38px;
    width: 38px;
    cursor: pointer;
    background: #0B0C0C url("/public/images/search-button.png") no-repeat 2px 50%;
    border: 0;
    border-radius: 0;
  }

  .layer_controls {
    position: absolute;
    bottom: -10px;
    left: 10px;
    padding-right: 10px;
    min-width: 180px;
    max-width: 300px;
    width: 100%;
  }

  .govuk-template--rebranded {
    background: #fff;
  }
  .govuk-template--rebranded .govuk-header {
    background: #00703c;
  }

  .govuk-template--rebranded .govuk-header__link--homepage:not(:focus) {
    background-color: #00703c;
  }

  @media (min-width: 48.0625em) {
    .govuk-template--rebranded .govuk-header__service-name {
      position: relative;
      margin: 0px 0 11px;
      bottom: 8px;
    }
  }
</style>
{% endblock %}



{% block content %}
<div id="container" class="govuk-grid-row">

  <div class="navbar govuk-grid-column-20-percent">

    <h2 class="govuk-heading-s">
      Search by postcode or title number
    </h2>
    <div class="search-bar govuk-!-padding-top-0 govuk-!-margin-bottom-2">
      <input class="govuk-input search-field map__search_term" id="search-field" name="search" type="text"
        autocomplete="on">
      <div class="search-bar-input">
        <button class="search-button map__search_button" type="button" name="search" id="find-btn">
        </button>
      </div>
    </div>


    <p class="govuk-body-s" id="map_notes">Click the map to see information about a title<br />&nbsp;</p>

  </div>

  <div class="max-width">
    {{ hmlrSimpleMap({
      alt: "HMLR map component",
      caption: "Â© Crown copyright and database rights 2025 Ordnance Survey AC0000851063. Use of this data is subject to Ordnance Survey",
      width: "100%",
      height: "100%",
      layer_controls: "true",
      layers:[
        {
          description:"Registrations (INSPIRE)",
          interactive: "true",
          style: {
            fill: {
              color: "#4c2c9244"
            },
            stroke: {
              color: "#4c2c9299",
              width: 1
            }
          }
        },
          {
          description:"Postcode",
          style: {
            fill: {
              color: "#d4351c33"
            },
            stroke: {
              color: "#d4351c",
              width: 3,
              lineDash: [10, 6]
            }
          }
        }
      ],
      tile_url: 'https://a.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png'
    }) }}


  </div>

</div>


{% endblock %}





{% block pageScripts %}
<script>

  function setElementHeight(selector, aspectRatio) {
    const el = document.querySelector(selector);
    if (!el) return;

    function updateHeight() {
      el.style.height = window.innerHeight - 120 + 'px';
    }

    // Run on load and resize
    window.addEventListener('load', updateHeight);
    window.addEventListener('resize', updateHeight);
  }

  setElementHeight('.hmlr-map-wrapper');
  setElementHeight('#navbar');


  const addresses = [
    [
      "Moorland Road, Leeds, LS6 1AN",
      "Cardigan Road, Leeds, LS6 1LJ",
      "Hyde Park Road, Leeds, LS6 1AG",
      "Brudenell Road, Leeds, LS6 1EG",
      "St Michael's Lane, Leeds, LS6 3BR",
      "Headingley Lane, Leeds, LS6 2AS",
      "Ash Road, Leeds, LS6 3HD",
      "Royal Park Avenue, Leeds, LS6 1EY",
      "Burchett Place, Leeds, LS6 1LY",
      "Moorland Avenue, Leeds, LS6 4BX"
    ],
    [
      "Marmaduke Street, Liverpool, L7 1PB",
      "Bentley Road, Liverpool, L8 0SY",
      "Princes Avenue, Liverpool, L8 0TH",
      "Upper Parliament Street, Liverpool, L8 7LA",
      "Kingsley Road, Liverpool, L8 0SX",
      "Sefton Park Road, Liverpool, L8 0SR",
      "Croxteth Grove, Liverpool, L8 0SP",
      "Princes Road, Liverpool, L8 1TH",
      "Aigburth Drive, Liverpool, L17 4JZ",
      "Catherine Street, Liverpool, L8 7NL"
    ],

    [
      "Ashton Drive, Bristol, BS3 2PT",
      "Duckmoor Road, Bristol, BS3 2BY",
      "Greville Road, Bristol, BS3 2LB",
      "Ashton Gate Road, Bristol, BS3 2EJ",
      "North Street, Bristol, BS3 1JE",
      "Ashton Road, Bristol, BS3 2EA",
      "Baynton Road, Bristol, BS3 2JX",
      "Coronation Road, Bristol, BS3 1RU",
      "Frayne Road, Bristol, BS3 2JT",
      "Clanage Road, Bristol, BS3 2JU"
    ]
  ];

  const geojson = [
    "/public/data/leeds.geojson",
    "/public/data/liverpool.geojson",
    "/public/data/bristol.geojson"
  ];

  const postcodes = [
    "/public/data/LS6_1AL.geojson",
    "/public/data/L7_1PB.geojson",
    "/public/data/BS3_2PT.geojson"
  ];


  async function getPostcodePolygon(postcode) {
    const overpassUrl = "https://overpass-api.de/api/interpreter";

    // Overpass query: Find relations with postal_code tag
    const query = `
        [out:json][timeout:25];
        area["ISO3166-1"="GB"][admin_level=2];
        (
          relation["postal_code"="${postcode}"]["boundary"="postal_code"];
          way["postal_code"="${postcode}"]["boundary"="postal_code"];
        );
        out geom;
      `;

    try {
      const response = await fetch(overpassUrl, {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: query
      });

      if (!response.ok) {
        throw new Error(`Overpass API error: ${response.status}`);
      }

      const data = await response.json();
      console.log(data);


      if (!data.elements || data.elements.length === 0) {
        console.log("No polygon found for this postcode.");
        return null;
      }

      // Convert to GeoJSON
      const features = data.elements.map(element => {
        if (element.geometry) {
          const coords = element.geometry.map(pt => [pt.lon, pt.lat]);
          return {
            type: "Feature",
            properties: { id: element.id, tags: element.tags },
            geometry: {
              type: "Polygon",
              coordinates: [coords]
            }
          };
        }
      }).filter(Boolean);

      return {
        type: "FeatureCollection",
        features: features
      };

    } catch (error) {
      console.error("Error fetching postcode polygon:", error);
      return null;
    }
  }


  document.addEventListener("DOMContentLoaded", (event) => {

    // add custom listener for map event: hmlrMapClickEvent
    document.addEventListener('hmlrMapClickEvent', (event) => {
      const message = event.detail.message;
      const INSPIREID = message.values_.INSPIREID;
      const id = Math.floor(Math.random() * 10);
      let address = addresses[count][id];
      if (address === undefined) {
        address = "No property of measurable worth" + "<br/>&nbsp;";
      }
      document.getElementById("map_notes").innerHTML = "INSPIRE ID " + INSPIREID + ":<br/> " + address;
    });

    var count = -1;

    const retrievedMap = document.getElementById('map1')._olMap;
    const searchField = document.getElementById('search-field');
    document.getElementById('find-btn').addEventListener('click', (event) => {
      document.getElementById("map_notes").innerHTML = "";
      count++;
      if (count >= 3) count = 0;
      
      path_to_geometry = geojson[count];
      postcode = postcodes[count];
      addBoundary(path_to_geometry, 1, retrievedMap);
      addBoundary(postcode, 2, retrievedMap);
      addHover(retrievedMap)

      //console.log(searchField.value);

      // Example usage:
      /* getPostcodePolygon(searchField.value).then(geojson => {
        console.log(JSON.stringify(geojson, null, 2));
      });  */
    });


    async function addBoundary(path_to_geometry, layerCount, map) {
      // get the source to load the polygons into 
      const source = map.getLayers().item(layerCount).getSource();
      const view = map.getView();
      const center = view.getCenter();

      source.clear();

      try {
        const response = await fetch(path_to_geometry);

        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        // add features from GeoJSON
        let geojsonData = await response.json();
        const features = new ol.format.GeoJSON().readFeatures(geojsonData);

        source.addFeatures(features);

      } catch (error) {
        console.error('Error loading geojson:', error);
      } finally {
        //console.log('finished loading geojson');
      }

      // fit view to loaded features
      const extent = source.getExtent();
      // center the view on the new geometry
      if (extent && extent.some(coord => isFinite(coord))) {
        map.getView().fit(extent, {
          padding: [20, 20, 20, 20],
          maxZoom: 18
        });

      }


    }

    let hoverStyle = new ol.style.Style({
      fill: new ol.style.Fill({
        color: 'rgba(0,48,120,0.3)'
      }),
      stroke: new ol.style.Stroke({
        color: 'rgba(0,48,120,1)',
        width: 2
      })
    })


    function addHover(map) {
      // Add interaction for hover effects
      let hoveredFeature = null;
      const mapElement = map.getTargetElement();

      map.on('pointermove', function (evt) {
        const feature = map.forEachFeatureAtPixel(evt.pixel, function (feature) {
          return feature;
        });

        if (feature !== hoveredFeature) {
          // Reset previous hovered feature to default style
          if (hoveredFeature) {
            hoveredFeature.setStyle(null); // Reset to layer default style
          }

          // Set new hovered feature
          if (feature) {
            feature.setStyle(hoverStyle);
            mapElement.style.cursor = 'pointer';
          } else {
            mapElement.style.cursor = '';
          }

          hoveredFeature = feature;
        }
      });

      // Add explicit mouse leave handling for map container
      mapElement.addEventListener('mouseleave', function () {
        if (hoveredFeature) {
          hoveredFeature.setStyle(null); // Reset to layer default style
          hoveredFeature = null;
          mapElement.style.cursor = '';
        }
      });

      // Add click handler for feature info
      map.on('click', function (evt) {
        const feature = map.forEachFeatureAtPixel(evt.pixel, function (feature) {
          return feature;
        });

        if (feature) {
          // dispatch a custom event
          const mapEvent = new CustomEvent('hmlrMapClickEvent', {
            detail: { message: feature }
          });
          document.dispatchEvent(mapEvent);
        }
      });
    }

  })


</script>
{% endblock %}